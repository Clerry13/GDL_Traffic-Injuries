**data are available: http://www.ahw.gov.ab.ca/IHDA_Retrieval/selectCategory.do 
*-> injury 
*-> injury- age-sex specific emergency department visit rates (monthly)
*select each age group (not all), male & female (not both), all dates available, and traffic related injury (1)
*import csv into selected software
*analysed in STATA 16 IC

* Ensure data are sorted chronologically
rename*,lower
split year, parse("_")
rename year2 month
rename year1 year
sort year month

* Continuous time variable (months since start)
gen t = _n

* Indicator for post-policy period (July 2023 onward)
gen post = (year > 2023 | (year == 2023 & month >= 7))

* Time since policy implementation (0 before policy)
gen time_after = 0
replace time_after = t - t[post == 1][1] if post == 1

label variable post "Immediate post-policy indicator"
label variable time_after "Months since policy implementation"

*Generate season variable based on month variable
describe month
gen month_num = month(dofm(month))
tab month_num
gen season=. 
replace season=1 if month_num==12
replace season=1 if month_num==1
replace season=1 if month_num==2
replace season=2 if month_num==3
replace season=2 if month_num==4
replace season=2 if month_num==5
replace season=3 if month_num==6
replace season=3 if month_num==7
replace season=3 if month_num==8
replace season=4 if month_num==9
replace season=4 if month_num==10
replace season=4 if month_num==11
*season1 = winter, season 2= spring, season 3= summer, season 4=fall

*clean age and sex vars
encode age, gen(age_grp)
encode sex, gen(gender)

*regression analysis
*test whether poisson or nbreg satisfies assumptions
poisson visits post time_after, exposure(population)
nbreg visits post time_after, exposure(population)
estat gof, pearson
*evidence of zero inflation in poisson models determined
*All Traffic Injuries
* Unadjusted
nbreg visits post time_after, ///
    exposure(population) irr

* Adjusted
nbreg visits post time_after ///
    i.agegrp i.gender, ///
    exposure(population) irr

*using similar cleaning process above, import CSVs for each type of traffic injury ED visits and append to original data file
* Unadjusted
nbreg visits post time_after ///
    if driver == 1, ///
    exposure(population) irr

* Adjusted
nbreg visits post time_after ///
    i.agegrp i.gender i.season ///
    if driver == 1, ///
    exposure(population) irr

* Unadjusted
nbreg visits post time_after ///
    if passenger == 1, ///
    exposure(population) irr

* Adjusted
nbreg visits post time_after ///
    i.agegrp i.gender i.season ///
    if passenger == 1, ///
    exposure(population) irr

* Unadjusted
nbreg visits post time_after ///
    if motorcycledr == 1, ///
    exposure(population) irr

* Adjusted
nbreg visits post time_after ///
    i.agegrp i.gender i.season ///
    if motorcycledr == 1, ///
    exposure(population) irr

* Unadjusted
nbreg visits post time_after ///
    if motorcyclepas == 1, ///
    exposure(population) irr

* Adjusted
nbreg visits post time_after ///
    i.agegrp i.gender i.season ///
    if motorcyclepas == 1, ///
    exposure(population) irr

* Unadjusted
nbreg visits post time_after ///
    if pedest == 1, ///
    exposure(population) irr

* Adjusted
nbreg visits post time_after ///
    i.agegrp i.gender i.season  ///
    if pedest == 1, ///
    exposure(population) irr

* Unadjusted
nbreg visits post time_after ///
    if other == 1, ///
    exposure(population) irr

* Adjusted
nbreg visits post time_after ///
    i.agegrp i.gender i.season ///
    if other == 1, ///
    exposure(population) irr
